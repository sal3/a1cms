/*
 * jQuery UI Nested Sortable
 * v 1.3.5 / 21 jun 2012
 * http://mjsarfatti.com/code/nestedSortable
 *
 * Depends on:
 *	 jquery.ui.sortable.js 1.8+
 *
 * Copyright (c) 2010-2012 Manuele J Sarfatti
 * Licensed under the MIT License
 * http://www.opensource.org/licenses/mit-license.php
 */
(function(a){a.widget("mjs.nestedSortable",a.extend({},a.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",doNotClear:!1,listType:"ol",maxLevels:0,protectRoot:!1,rootID:null,rtl:!1,isAllowed:function(){return!0}},_create:function(){this.element.data("sortable",this.element.data("nestedSortable"));if(!this.element.is(this.options.listType))throw Error("nestedSortable: Please check the listType option is set to your actual list type");
return a.ui.sortable.prototype._create.apply(this,arguments)},destroy:function(){this.element.removeData("nestedSortable").unbind(".nestedSortable");return a.ui.sortable.prototype.destroy.apply(this,arguments)},_mouseDrag:function(c){this.position=this._generatePosition(c);this.positionAbs=this._convertPositionTo("absolute");this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs);var b=this.options;if(this.options.scroll){var d=!1;this.scrollParent[0]!=document&&"HTML"!=this.scrollParent[0].tagName?
(this.overflowOffset.top+this.scrollParent[0].offsetHeight-c.pageY<b.scrollSensitivity?this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop+b.scrollSpeed:c.pageY-this.overflowOffset.top<b.scrollSensitivity&&(this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop-b.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-c.pageX<b.scrollSensitivity?this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft+b.scrollSpeed:c.pageX-this.overflowOffset.left<b.scrollSensitivity&&
(this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft-b.scrollSpeed)):(c.pageY-a(document).scrollTop()<b.scrollSensitivity?d=a(document).scrollTop(a(document).scrollTop()-b.scrollSpeed):a(window).height()-(c.pageY-a(document).scrollTop())<b.scrollSensitivity&&(d=a(document).scrollTop(a(document).scrollTop()+b.scrollSpeed)),c.pageX-a(document).scrollLeft()<b.scrollSensitivity?d=a(document).scrollLeft(a(document).scrollLeft()-b.scrollSpeed):a(window).width()-(c.pageX-a(document).scrollLeft())<
b.scrollSensitivity&&(d=a(document).scrollLeft(a(document).scrollLeft()+b.scrollSpeed)));!1!==d&&(a.ui.ddmanager&&!b.dropBehaviour)&&a.ui.ddmanager.prepareOffsets(this,c)}this.positionAbs=this._convertPositionTo("absolute");d=this.placeholder.offset().top;if(!this.options.axis||"y"!=this.options.axis)this.helper[0].style.left=this.position.left+"px";if(!this.options.axis||"x"!=this.options.axis)this.helper[0].style.top=this.position.top+"px";for(var e=this.items.length-1;0<=e;e--){var f=this.items[e],
g=f.item[0],h=this._intersectsWithPointer(f);if(h&&g!=this.currentItem[0]&&this.placeholder[1==h?"next":"prev"]()[0]!=g&&!a.contains(this.placeholder[0],g)&&("semi-dynamic"==this.options.type?!a.contains(this.element[0],g):1)){a(g).mouseenter();this.direction=1==h?"down":"up";if("pointer"==this.options.tolerance||this._intersectsWithSides(f))a(g).mouseleave(),this._rearrange(c,f);else break;this._clearEmpty(g);this._trigger("change",c,this._uiHash());break}}e=this.placeholder[0].parentNode.parentNode&&
a(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?a(this.placeholder[0].parentNode.parentNode):null;f=this._getLevel(this.placeholder);g=this._getChildLevels(this.helper);h=this.placeholder[0].previousSibling?a(this.placeholder[0].previousSibling):null;if(null!=h)for(;"li"!=h[0].nodeName.toLowerCase()||h[0]==this.currentItem[0]||h[0]==this.helper[0];)if(h[0].previousSibling)h=a(h[0].previousSibling);else{h=null;break}var j=this.placeholder[0].nextSibling?a(this.placeholder[0].nextSibling):
null;if(null!=j)for(;"li"!=j[0].nodeName.toLowerCase()||j[0]==this.currentItem[0]||j[0]==this.helper[0];)if(j[0].nextSibling)j=a(j[0].nextSibling);else{j=null;break}var k=document.createElement(b.listType);this.beyondMaxLevels=0;null!=e&&null==j&&(b.rtl&&this.positionAbs.left+this.helper.outerWidth()>e.offset().left+e.outerWidth()||!b.rtl&&this.positionAbs.left<e.offset().left)?(e.after(this.placeholder[0]),this._clearEmpty(e[0]),this._trigger("change",c,this._uiHash())):null!=h&&(b.rtl&&this.positionAbs.left+
this.helper.outerWidth()<h.offset().left+h.outerWidth()-b.tabSize||!b.rtl&&this.positionAbs.left>h.offset().left+b.tabSize)?(this._isAllowed(h,f,f+g+1),h.children(b.listType).length||h[0].appendChild(k),d&&d<=h.offset().top?h.children(b.listType).prepend(this.placeholder):h.children(b.listType)[0].appendChild(this.placeholder[0]),this._trigger("change",c,this._uiHash())):this._isAllowed(e,f,f+g);this._contactContainers(c);a.ui.ddmanager&&a.ui.ddmanager.drag(this,c);this._trigger("sort",c,this._uiHash());
this.lastPositionAbs=this.positionAbs;return!1},_mouseStop:function(c,b){this.beyondMaxLevels&&(this.placeholder.removeClass(this.options.errorClass),this.domPosition.prev?a(this.domPosition.prev).after(this.placeholder):a(this.domPosition.parent).prepend(this.placeholder),this._trigger("revert",c,this._uiHash()));for(var d=this.items.length-1;0<=d;d--)this._clearEmpty(this.items[d].item[0]);a.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(c){var b=a.extend({},this.options,
c);c=this._getItemsAsjQuery(b&&b.connected);var d=[];a(c).each(function(){var c=(a(b.item||this).attr(b.attribute||"id")||"").match(b.expression||/(.+)[-=_](.+)/),f=(a(b.item||this).parent(b.listType).parent(b.items).attr(b.attribute||"id")||"").match(b.expression||/(.+)[-=_](.+)/);c&&d.push((b.key||c[1])+"["+(b.key&&b.expression?c[1]:c[2])+"]="+(f?b.key&&b.expression?f[1]:f[2]:b.rootID))});!d.length&&b.key&&d.push(b.key+"=");return d.join("&")},toHierarchy:function(c){function b(c){var e=(a(c).attr(d.attribute||
"id")||"").match(d.expression||/(.+)[-=_](.+)/);if(e){var h={id:e[2]};0<a(c).children(d.listType).children(d.items).length&&(h.children=[],a(c).children(d.listType).children(d.items).each(function(){var a=b(this);h.children.push(a)}));return h}}var d=a.extend({},this.options,c),e=[];a(this.element).children(d.items).each(function(){var a=b(this);e.push(a)});return e},toArray:function(c){function b(c,g,k){var l=k+1,m;0<a(c).children(d.listType).children(d.items).length&&(g++,a(c).children(d.listType).children(d.items).each(function(){l=
b(a(this),g,l)}),g--);m=a(c).attr(d.attribute||"id").match(d.expression||/(.+)[-=_](.+)/);c=g===e+1?d.rootID:a(c).parent(d.listType).parent(d.items).attr(d.attribute||"id").match(d.expression||/(.+)[-=_](.+)/)[2];m&&f.push({item_id:m[2],parent_id:c,depth:g,left:k,right:l});return l+1}var d=a.extend({},this.options,c),e=d.startDepthCount||0,f=[],g=2;f.push({item_id:d.rootID,parent_id:"none",depth:e,left:"1",right:2*(a(d.items,this.element).length+1)});a(this.element).children(d.items).each(function(){g=
b(this,e+1,g)});return f=f.sort(function(a,c){return a.left-c.left})},_clearEmpty:function(c){c=a(c).children(this.options.listType);c.length&&(!c.children().length&&!this.options.doNotClear)&&c.remove()},_getLevel:function(a){var b=1;if(this.options.listType)for(a=a.closest(this.options.listType);a&&0<a.length&&!a.is(".ui-sortable");)b++,a=a.parent().closest(this.options.listType);return b},_getChildLevels:function(c,b){var d=this,e=this.options,f=0;b=b||0;a(c).children(e.listType).children(e.items).each(function(a,
c){f=Math.max(d._getChildLevels(c,b+1),f)});return b?f+1:f},_isAllowed:function(c,b,d){var e=this.options,f=a(this.domPosition.parent).hasClass("ui-sortable")?!0:!1,g=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels");!e.isAllowed(this.currentItem,c)||c&&c.hasClass(e.disableNesting)||e.protectRoot&&(null==c&&!f||f&&1<b)?(this.placeholder.addClass(e.errorClass),this.beyondMaxLevels=g<d&&0!=g?d-g:1):g<d&&0!=g?(this.placeholder.addClass(e.errorClass),this.beyondMaxLevels=d-
g):(this.placeholder.removeClass(e.errorClass),this.beyondMaxLevels=0)}}));a.mjs.nestedSortable.prototype.options=a.extend({},a.ui.sortable.prototype.options,a.mjs.nestedSortable.prototype.options)})(jQuery);